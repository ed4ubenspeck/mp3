---
title: "Markdown File"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sf)
library(raster)
library(macleish)
library(leaflet)
library(tidyverse)
```


Aggregating trail segments: **Do lengths change based on projection?
```{r}
total_trails <- macleish_layers[["trails"]] %>%
  group_by(name) %>%
  summarize(num_segments = n(), 
            total_length = sum(st_length(geometry)))
```


Testing plots
```{r}

contour_char <- macleish_layers[["contours_3m"]] %>%
  mutate(meter_char = as.character(ELEV_M))

color_fact <- colorFactor("Greens", contour_char$meter_char)
color_fact2 <- colorFactor("Set1", macleish_layers[["trails"]]$name)

m <- leaflet() %>%
  # Base groups
  addTiles(group = "OpenStreetMap") %>%
  addProviderTiles("Esri.WorldTopoMap", group = "Topography") %>%
  addProviderTiles("Esri.WorldImagery", group = "Satellite") %>%
  addProviderTiles("Stamen.TonerLite", group = "Toner Lite") %>%
    addPolygons(data = macleish_layers[["boundary"]], weight = 1, fillOpacity = 0.01, group = "Boundaries") %>%
  #other stuff
  addPolygons(data = contour_char, popup = ~meter_char, color = ~color_fact(meter_char), weight = .5) %>%
  addPolylines(data = macleish_layers[["trails"]], weight = 4, popup = ~name, color = ~color_fact2(name))

```

Total change in grade dataframe

```{r}
## list of trail names to apply to function
trails_by_name <- c("Driveway", "Eastern Loop", "Easy Out", "entry trail", "Poplar Hill Road", "Porcupine Trail", "Snowmobile Trail", "Vernal Pool Loop", "Western Loop")

## function to filter by trail name
trail_tables <- function(trail_name){
  total_trails %>%
  filter(name == trail_name)
}

## making a list of dataframes for each trail  
aggregate <- lapply(trails_by_name, trail_tables)

## function to join each trail table with elevation layer and find max grade, average grade, 
total_change_grade <- function(trail_table){  
  contour_char %>%
  st_join(trail_table, join = st_intersects, left=FALSE) %>%
    group_by(name) %>%
    mutate(total_grade = max(ELEV_M) - min(ELEV_M)) %>%
    mutate(avg_grade = mean(ELEV_M)) %>%
    mutate(difference = c(NA, diff(ELEV_M))) %>%
    arrange(desc(difference)) %>%
    na.omit(difference) %>%
    as.data.frame(trail_table) %>%
    head(1)
}

## making a list of joined tables
total_change_grade_tables <- lapply(aggregate, total_change_grade)

## informative dataframe
grade_tables <- do.call("rbind", total_change_grade_tables) %>%
  dplyr::select(name, total_grade_meters = total_grade, avg_grade_meters = avg_grade, total_length, max_change_grade = difference)


```

